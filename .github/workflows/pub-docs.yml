name: pub-docs

on:
  workflow_dispatch: {}
  push:
    branches: [main]
    paths:
      - "frames/**"
      - "tools/**"
      - "governance/**"
      - "pub/**"
      - ".github/workflows/pub-docs.yml"

# Required for pushing to gh-pages
permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install tectonic (PDF build tool)
        shell: bash
        run: |
          set -euo pipefail

          if command -v tectonic >/dev/null 2>&1; then
            tectonic --version
            exit 0
          fi

          echo "Attempting tectonic install via apt-get..."
          sudo apt-get update -y
          if sudo apt-get install -y tectonic; then
            tectonic --version
            exit 0
          fi

          echo "apt-get install tectonic failed; falling back to pinned binary download"

          # Pin the version to keep builds reproducible.
          TECTONIC_VERSION="0.15.0"
          ARCH="x86_64"
          OS="unknown-linux-gnu"
          URL="https://github.com/tectonic-typesetting/tectonic/releases/download/tectonic%40${TECTONIC_VERSION}/tectonic-${TECTONIC_VERSION}-${ARCH}-${OS}.tar.gz"

          tmpdir="$(mktemp -d)"
          trap 'rm -rf "$tmpdir"' EXIT

          curl -fsSL "$URL" -o "$tmpdir/tectonic.tgz"
          tar -xzf "$tmpdir/tectonic.tgz" -C "$tmpdir"

          # The tarball contains `tectonic` at top-level.
          sudo install -m 0755 "$tmpdir/tectonic" /usr/local/bin/tectonic
          tectonic --version

      - name: Run core repo gates
        shell: bash
        run: |
          set -euo pipefail
          export GIT_PAGER=cat
          export PAGER=cat
          export GIT_TERMINAL_PROMPT=0

          ./tools/enforce_repo_law/run
          ./tools/validate_group/run
          ./tools/validate_references/run

      - name: Build publication artifacts (DocIR → LaTeX + PDF + MANIFEST)
        shell: bash
        run: |
          set -euo pipefail

          build_one() {
            local frame="$1"
            local outbase="$2"
            local name="$3"

            mkdir -p "$outbase/src" "$outbase/out" out/docir

            # Keep DocIR path stable so later steps (Markdown / Pages) can reuse it.
            ./tools/render_docir/run --in "$frame" --out "out/docir/${name}.json"
            ./tools/render_tex_doc/run --in "out/docir/${name}.json" --out-dir "$outbase/src"
            ./tools/pub_build_pdf/run --src "$outbase/src" --out "$outbase/out" --name "$name"
            ./tools/pub_manifest/run --frame "$frame" --src "$outbase/src" --pdf "$outbase/out/${name}.pdf" --out "$outbase/MANIFEST.json"
          }

          build_one "frames/domains/spec/systemics/sigma-k1/v0.1.0/frame.yml" "pub/systemics/sigma-k1/v0.1.0" "sigma-k1-v0.1.0"
          build_one "frames/domains/spec/systemics/sigma-composition-k1/v0.1.0/frame.yml" "pub/systemics/sigma-composition-k1/v0.1.0" "sigma-composition-k1-v0.1.0"

      - name: Render human Markdown specs (DocIR → Markdown)
        shell: bash
        run: |
          set -euo pipefail

          mkdir -p out/docir out/docs

          # Reuse DocIR JSON that was produced during the PDF build step when available.
          if [[ ! -f out/docir/sigma-k1-v0.1.0.json ]]; then
            ./tools/render_docir/run --in frames/domains/spec/systemics/sigma-k1/v0.1.0/frame.yml --out out/docir/sigma-k1-v0.1.0.json
          fi
          ./tools/render_md_doc/run --in out/docir/sigma-k1-v0.1.0.json --out out/docs/sigma-k1-v0.1.0.md

          if [[ ! -f out/docir/sigma-composition-k1-v0.1.0.json ]]; then
            ./tools/render_docir/run --in frames/domains/spec/systemics/sigma-composition-k1/v0.1.0/frame.yml --out out/docir/sigma-composition-k1-v0.1.0.json
          fi
          ./tools/render_md_doc/run --in out/docir/sigma-composition-k1-v0.1.0.json --out out/docs/sigma-composition-k1-v0.1.0.md

      - name: Prepare GitHub Pages content
        shell: bash
        run: |
          set -euo pipefail

          rm -rf site
          mkdir -p site

          cp -R pub site/pub

          # Publish rendered Markdown docs for human reading.
          mkdir -p site/docs
          if [[ -d out/docs ]]; then
            cp -R out/docs/* site/docs/ || true
          fi

          # Include the repo's human index on Pages.
          if [[ -f INDEX.md ]]; then
            cp INDEX.md site/INDEX.md
          fi

          cat > site/index.html <<'HTML'
          <!doctype html>
          <html lang="en">
            <head>
              <meta charset="utf-8" />
              <meta name="viewport" content="width=device-width, initial-scale=1" />
              <title>framecodex Publications</title>
              <style>
                body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 2rem; }
                code { background: #f5f5f5; padding: 0.1rem 0.3rem; border-radius: 4px; }
              </style>
            </head>
            <body>
              <h1>framecodex Publications</h1>
              <p>Rendered artifacts published from <code>main</code>.</p>

              <h2>Indexes</h2>
              <ul>
                <li><a href="INDEX.md">Repo index (INDEX.md)</a></li>
              </ul>

              <h2>Human docs (Markdown)</h2>
              <ul>
                <li><a href="docs/sigma-k1-v0.1.0.md">Sigma K1 v0.1.0 (Markdown)</a></li>
                <li><a href="docs/sigma-composition-k1-v0.1.0.md">Sigma Composition K1 v0.1.0 (Markdown)</a></li>
              </ul>

              <h2>PDFs</h2>
              <ul>
                <li><a href="pub/systemics/sigma-k1/v0.1.0/out/sigma-k1-v0.1.0.pdf">Sigma K1 v0.1.0 (PDF)</a></li>
                <li><a href="pub/systemics/sigma-composition-k1/v0.1.0/out/sigma-composition-k1-v0.1.0.pdf">Sigma Composition K1 v0.1.0 (PDF)</a></li>
              </ul>
            </body>
          </html>
          HTML

      - name: Deploy to gh-pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_branch: gh-pages
          publish_dir: site

      - name: Upload pub artifacts
        uses: actions/upload-artifact@v4
        with:
          name: pub-artifacts
          path: |
            pub/**
            out/**
