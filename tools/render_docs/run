#!/usr/bin/env bash
set -euo pipefail

repo_root="$(cd "$(dirname "$0")/../.." && pwd)"
mkdir -p "$repo_root/docs" "$repo_root/out/render_docs"

# Deterministically render docs for all canonical frames in frames/**/v*/frame.yml.
"$repo_root/tools/render_simple_md/run" >/dev/null

# Deterministically emit MANIFEST.json describing outputs.
python3 - <<'PY'
import json
from pathlib import Path

root = Path('.').resolve()
out = root / 'out' / 'render_simple_md' / 'report.json'
report = json.loads(out.read_text(encoding='utf-8'))

manifest = {
  "manifest_version": "0.1.0",
  "generated_by": {"tool": "render_docs", "version": "0.2.0"},
  "active": {
    "law": {"graph_id": "law://repo/governance/repo-law-k1", "version": "0.1.0"}
  },
  "inputs": sorted(
    [{"path": o["input"], "graph_id": o["graph_id"], "version": o["version"]} for o in report.get("outputs", [])],
    key=lambda x: (x["graph_id"], x["version"], x["path"]),
  ),
  "outputs": sorted(
    [{"path": o["output"], "graph_id": o["graph_id"], "version": o["version"]} for o in report.get("outputs", [])],
    key=lambda x: (x["graph_id"], x["version"], x["path"]),
  ),
}

(root / 'docs' / 'MANIFEST.json').write_text(json.dumps(manifest, indent=2, sort_keys=True) + "\n", encoding='utf-8')
PY
